(function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)})(function(e){function r(a,b){"string"==typeof a?a=RegExp(a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),b?"gi":"g"):a.global||(a=RegExp(a.source,a.ignoreCase?"gi":"g"));return{token:function(b){a.lastIndex=b.pos;var c=
a.exec(b.string);if(c&&c.index==b.pos)return b.pos+=c[0].length,"searching";c?b.pos=c.index:b.skipToEnd()}}}function s(){this.overlay=this.posFrom=this.posTo=this.lastQuery=this.query=null}function f(a){return a.state.search||(a.state.search=new s)}function g(a){return"string"==typeof a&&a==a.toLowerCase()}function h(a,b,d){return a.getSearchCursor(b,d,g(b))}function t(a,b,d,c){a.openDialog(b,c,{value:d,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){i(a)}})}function k(a,b,d,c,e){a.openDialog?
a.openDialog(b,e,{value:c,selectValueOnOpen:!0}):e(prompt(d,c))}function u(a,b,d,c){if(a.openConfirm)a.openConfirm(b,c);else if(confirm(d))c[0]()}function n(a){var b=a.match(/^\/(.*)\/([a-z]*)$/);if(b)try{a=RegExp(b[1],-1==b[2].indexOf("i")?"":"i")}catch(d){}if("string"==typeof a?""==a:a.test(""))a=/x^/;return a}function o(a,b,d){b.queryText=d;b.query=n(d);a.removeOverlay(b.overlay,g(b.query));b.overlay=r(b.query,g(b.query));a.addOverlay(b.overlay);a.showMatchesOnScrollbar&&(b.annotate&&(b.annotate.clear(),
b.annotate=null),b.annotate=a.showMatchesOnScrollbar(b.query,g(b.query)))}function j(a,b,d){var c=f(a);if(c.query)return l(a,b);var m=a.getSelection()||c.lastQuery;d&&a.openDialog?t(a,p,m,function(b,d){e.e_stop(d);b&&(b!=c.queryText&&o(a,c,b),l(a,d.shiftKey))}):k(a,p,"Search for:",m,function(d){d&&!c.query&&a.operation(function(){o(a,c,d);c.posFrom=c.posTo=a.getCursor();l(a,b)})})}function l(a,b){a.operation(function(){var d=f(a),c=h(a,d.query,b?d.posFrom:d.posTo);if(!c.find(b)&&(c=h(a,d.query,b?
e.Pos(a.lastLine()):e.Pos(a.firstLine(),0)),!c.find(b)))return;a.setSelection(c.from(),c.to());a.scrollIntoView({from:c.from(),to:c.to()},20);d.posFrom=c.from();d.posTo=c.to()})}function i(a){a.operation(function(){var b=f(a);if(b.lastQuery=b.query)b.query=b.queryText=null,a.removeOverlay(b.overlay),b.annotate&&(b.annotate.clear(),b.annotate=null)})}function q(a,b){if(!a.getOption("readOnly")){var d=a.getSelection()||f(a).lastQuery;k(a,v,"Replace:",d,function(c){c&&(c=n(c),k(a,w,"Replace with:","",
function(d){if(b)a.operation(function(){for(var b=h(a,c);b.findNext();)if("string"!=typeof c){var e=a.getRange(b.from(),b.to()).match(c);b.replace(d.replace(/\$(\d)/g,function(a,b){return e[b]}))}else b.replace(d)});else{i(a);var e=h(a,c,a.getCursor()),f=function(){var b=e.from(),d;if(!(d=e.findNext()))if(e=h(a,c),!(d=e.findNext())||b&&e.from().line==b.line&&e.from().ch==b.ch)return;a.setSelection(e.from(),e.to());a.scrollIntoView({from:e.from(),to:e.to()});u(a,x,"Replace?",[function(){g(d)},f])},
g=function(a){e.replace("string"==typeof c?d:d.replace(/\$(\d)/g,function(b,c){return a[c]}));f()};f()}}))})}}var p='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',v='Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',w='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',
x="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";e.commands.find=function(a){i(a);j(a)};e.commands.findPersistent=function(a){i(a);j(a,!1,!0)};e.commands.findNext=j;e.commands.findPrev=function(a){j(a,!0)};e.commands.clearSearch=i;e.commands.replace=q;e.commands.replaceAll=function(a){q(a,!0)}});