(function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],e):e(CodeMirror)})(function(e){function o(c){if(c.getOption("disableInput"))return e.Pass;for(var g=c.listSelections(),a=[],d=0;d<g.length;d++){if(!g[d].empty())return e.Pass;var f=g[d].head,b=c.getTokenAt(f),j=e.innerMode(c.getMode(),b.state),k=j.state;if("xml"!=j.mode.name||!k.tagName)return e.Pass;
var h=c.getOption("autoCloseTags"),i="html"==j.mode.configuration,j="object"==typeof h&&h.dontCloseTags||i&&p,i="object"==typeof h&&h.indentTags||i&&q,h=k.tagName;b.end>f.ch&&(h=h.slice(0,h.length-b.end+f.ch));var l=h.toLowerCase();if(!h||"string"==b.type&&(b.end!=f.ch||!/[\"\']/.test(b.string.charAt(b.string.length-1))||1==b.string.length)||"tag"==b.type&&"closeTag"==k.type||b.string.indexOf("/")==b.string.length-1||j&&-1<m(j,l)||n(c,h,f,k,!0))return e.Pass;b=i&&-1<m(i,l);a[d]={indent:b,text:">"+
(b?"\n\n":"")+"</"+h+">",newPos:b?e.Pos(f.line+1,0):e.Pos(f.line,f.ch+1)}}for(d=g.length-1;0<=d;d--)f=a[d],c.replaceRange(f.text,g[d].head,g[d].anchor,"+insert"),b=c.listSelections().slice(0),b[d]={head:f.newPos,anchor:f.newPos},c.setSelections(b),f.indent&&(c.indentLine(f.newPos.line,null,!0),c.indentLine(f.newPos.line+1,null,!0))}function l(c,g){for(var a=c.listSelections(),d=[],f=g?"/":"</",b=0;b<a.length;b++){if(!a[b].empty())return e.Pass;var j=a[b].head,k=c.getTokenAt(j),h=e.innerMode(c.getMode(),
k.state),i=h.state;if(g&&("string"==k.type||"<"!=k.string.charAt(0)||k.start!=j.ch-1))return e.Pass;if("xml"!=h.mode.name)if("htmlmixed"==c.getMode().name&&"javascript"==h.mode.name)d[b]=f+"script>";else if("htmlmixed"==c.getMode().name&&"css"==h.mode.name)d[b]=f+"style>";else return e.Pass;else{if(!i.context||!i.context.tagName||n(c,i.context.tagName,j,i))return e.Pass;d[b]=f+i.context.tagName+">"}}c.replaceSelections(d);a=c.listSelections();for(b=0;b<a.length;b++)(b==a.length-1||a[b].head.line<
a[b+1].head.line)&&c.indentLine(a[b].head.line)}function m(c,e){if(c.indexOf)return c.indexOf(e);for(var a=0,d=c.length;a<d;++a)if(c[a]==e)return a;return-1}function n(c,g,a,d,f){if(!e.scanForClosingTag)return!1;var b=Math.min(c.lastLine()+1,a.line+500),a=e.scanForClosingTag(c,a,null,b);if(!a||a.tag!=g)return!1;d=d.context;for(f=f?1:0;d&&d.tagName==g;d=d.prev)++f;a=a.to;for(d=1;d<f;d++){a=e.scanForClosingTag(c,a,null,b);if(!a||a.tag!=g)return!1;a=a.to}return!0}e.defineOption("autoCloseTags",!1,function(c,
g,a){a!=e.Init&&a&&c.removeKeyMap("autoCloseTags");if(g){a={name:"autoCloseTags"};if(typeof g!="object"||g.whenClosing)a["'/'"]=function(a){a=a.getOption("disableInput")?e.Pass:l(a,true);return a};if(typeof g!="object"||g.whenOpening)a["'>'"]=function(a){return o(a)};c.addKeyMap(a)}});var p="area base br col command embed hr img input keygen link meta param source track wbr".split(" "),q="applet blockquote body button div dl fieldset form frameset h1 h2 h3 h4 h5 h6 head html iframe layer legend object ol p select table ul".split(" ");
e.commands.closeTag=function(c){return l(c)}});